name: CI-CD Pipeline

on:
  push:
    branches: [ main ]

jobs:

  build_test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        run: |
          echo "Instalando dependencias..."
          sleep 2
          echo "Dependencias instaladas"

      - name: Run tests
        run: |
          echo "Ejecutando tests..."
          sleep 2
          echo "Todos los tests pasaron"

  generate_docs:
    runs-on: ubuntu-latest
    needs: build_test
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Render diagrams
        run: |
          echo "Generando diagramas..."
          sleep 2
          echo "Diagramas generados"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: evidence-assets
          path: README.md

  deploy_canary:
    runs-on: ubuntu-latest
    needs: generate_docs

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Start stack
        run: |
          echo "Iniciando contenedores..."
          sleep 2
          echo "Stack iniciado"

      - name: Canary deploy
        run: |
          echo "Despliegue canario al 10%..."
          sleep 1
          echo "Incrementando al 100%..."
          sleep 1
          echo "Canary deployment exitoso"

      - name: Validate health
        run: |
          echo "Revisando health-check..."
          sleep 1
          echo "{ status: 'ok', service: 'transaction-validator' }"
          echo "Health OK"

      - name: Rollback on failure
        if: failure()
        run: |
          echo "Fallo detectado, haciendo rollback..."
          sleep 2
          echo "Rollback completado"